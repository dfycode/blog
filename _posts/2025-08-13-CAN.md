# CAN

## ç›®å½•

- [1.å…³äºCAN](#1å…³äºCAN)
  - [1.1ç”µæ°”ç‰¹æ€§](#11ç”µæ°”ç‰¹æ€§)
  - [1.2é€»è¾‘ç”µå¹³](#12é€»è¾‘ç”µå¹³)
  - [1.3  5ç§å¸§](#13--5ç§å¸§)
- [2.CAN æ§åˆ¶å™¨](#2CAN-æ§åˆ¶å™¨)
  - [2.1æ³¢ç‰¹ç‡](#21æ³¢ç‰¹ç‡)

> ğŸ«’1986 å¹´ 2 æœˆï¼Œ Robert Bosch GmbH åœ¨æ±½è½¦å·¥ç¨‹å¸ˆåä¼šï¼ˆSAEï¼‰å¤§ä¼šä¸Šæ¨å‡ºäº†æ§åˆ¶å™¨å±€åŸŸç½‘ï¼ˆCANï¼‰  ä¸²è¡Œæ€»çº¿ç³»ç»Ÿã€‚è¿™æ˜¯æœ‰å²ä»¥æ¥æœ€æˆåŠŸçš„ç½‘ç»œåè®®ä¹‹ä¸€è¯ç”Ÿçš„æ—¶åˆ»ã€‚å¦‚ä»Šï¼Œæ¬§æ´²å‡ ä¹æ‰€æœ‰æ±½è½¦éƒ½é…å¤‡äº†  è‡³å°‘ä¸€ä¸ª CAN ç½‘ç»œã€‚ CAN è¿˜ç”¨äºå…¶ä»–ç±»å‹çš„è½¦è¾†ï¼Œä»ç«è½¦åˆ°è½®èˆ¹ï¼Œä»¥åŠå·¥ä¸šæ§åˆ¶ä¸­ï¼Œ CAN æ˜¯æœ€ä¸» è¦çš„æ€»çº¿åè®®ä¹‹ä¸€ï¼Œç”šè‡³å¯èƒ½æ˜¯å…¨çƒé¢†å…ˆçš„ä¸²è¡Œæ€»çº¿ç³»ç»Ÿã€‚

ç»å…¸ CAN æ˜¯ 1Mbpsï¼Œ CAN FD æœ€é«˜ 2Mbpsï¼Œ CAN FD-SiC æ˜¯ 5-8Mbpsï¼Œ CAN XL æ˜¯ 10Mbpsã€‚

## 1.å…³äºCAN

> ğŸ«’SO11519å®šä¹‰äº†é€šä¿¡é€Ÿç‡ä¸º10ï½125Kbpsçš„ä½é€ŸCANé€šä¿¡æ ‡å‡†ï¼Œå±äºå¼€ç¯æ€»çº¿ï¼Œä¼ è¾“é€Ÿç‡ä¸º40Kbpsæ—¶ï¼Œæ€»çº¿é•¿åº¦å¯è¾¾1000ç±³ï¼›

> ğŸ«’ISO11898å®šä¹‰äº†é€šä¿¡é€Ÿç‡ä¸º125Kbpsï½1 Mbpsçš„é«˜é€ŸCANé€šä¿¡æ ‡å‡†ï¼Œå±äºé—­ç¯æ€»çº¿ï¼Œä¼ è¾“é€Ÿç‡å¯è¾¾1Mbpsï¼Œæ€»çº¿é•¿åº¦â‰¤40ç±³ï¼›

![](image/image_jfegpHNxdQ.png)

#### 1.1ç”µæ°”ç‰¹æ€§

> ğŸ«’æ¯ä¸ªèŠ‚ç‚¹è®¾å¤‡ç”±CANæ§åˆ¶å™¨å’ŒCANæ”¶å‘å™¨ç»„æˆï¼ŒCANæ§åˆ¶å™¨é€šå¸¸ä½œä¸ºå¤–è®¾é›†æˆåœ¨MPU/MCUä¸Šï¼Œè€ŒCANæ”¶å‘å™¨åˆ™éœ€è¦å¤–å›´æ·»åŠ èŠ¯ç‰‡ç”µè·¯ã€‚

![](image/image_j1O3md7_a2.png)

![](image/image_6hx6eJ3uQI.png)

#### 1.2é€»è¾‘ç”µå¹³

> ğŸ«’ç±»ä¼¼RS485ï¼ŒCANä¹Ÿä½¿ç”¨å·®åˆ†ä¿¡å·ä¼ è¾“æ•°æ®ã€‚CANæ€»çº¿ä½¿ç”¨CAN\_Hå’ŒCAN\_Lçš„ç”µä½å·®æ¥è¡¨ç¤ºæ•°æ®ç”µå¹³ã€‚ç”µä½å·®åˆ†ä¸ºæ˜¾æ€§ç”µå¹³å’Œéšæ€§ç”µå¹³ï¼Œåˆ†åˆ«è¡¨ç¤ºé€»è¾‘0å’Œ1ã€‚å¦‚å›¾ 23.1.3 æ‰€ç¤ºï¼Œæ˜¯ä½é€ŸCANï¼ˆISO11519æ ‡å‡†ï¼‰çš„ç”µå¹³å®šä¹‰ï¼Œå¦‚å›¾ 23.1.4 æ˜¯é«˜é€ŸCANï¼ˆISO11898æ ‡å‡†ï¼‰çš„ç”µå¹³å®šä¹‰ï¼Œä¸¤è€…ç‰©ç†å±‚ç”µæ°”ç‰¹æ€§ä¸ä¸€æ ·ï¼Œå› æ­¤ä¸èƒ½å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ã€‚å¯ä»¥çœ‹åˆ°å½“CAN\_Hå’ŒCAN\_Lç”µå‹ç›¸è¿‘ï¼Œåˆ™è¡¨ç¤ºéšæ€§ç”µå¹³ï¼Œå¯¹åº”é€»è¾‘1ï¼Œå½“ä¸¤ä¸ªç”µå‹ç›¸å·®è¾ƒå¤§ï¼Œè¡¨ç¤ºæ˜¾æ€§ç”µå¹³ï¼Œå¯¹åº”é€»è¾‘0ã€‚

![](image/image_w2KZ0qPye-.png)

![](image/image_iM221HaQo0.png)

#### 1.3  5ç§å¸§

> ğŸ«’CANæ€»çº¿ä»¥â€œå¸§â€ï¼ˆFrameï¼‰çš„å½¢å¼è¿›è¡Œé€šä¿¡ã€‚CAN æ€»çº¿åè®®è§„å®šäº†5ç§å¸§ï¼Œåˆ†åˆ«æ˜¯**æ•°æ®å¸§**ã€è¿œç¨‹å¸§ã€é”™è¯¯å¸§ã€è¶…è½½å¸§ä»¥åŠå¸§é—´éš”ï¼Œå…¶ä¸­**æ•°æ®å¸§**æœ€å¸¸ç”¨ã€‚

![](image/image_3HN7w78jSR.png)

![](image/image_F4O3nmM3UA.png)

> ğŸ‡å¸§èµ·å§‹(Start Of Frame-SOF)ï¼š1bitï¼Œæ˜¾æ€§ä¿¡å·ï¼Œè¡¨ç¤ºæ•°æ®å¸§ï¼ˆæˆ–è¿œç¨‹å¸§ï¼‰çš„å¼€å§‹ï¼›
> ä»²è£æ®µ(Arbitration Field)ï¼šåŒ…æ‹¬æ ‡è¯†ç¬¦ä½ï¼ˆIdentifier field-IDï¼‰å’Œè¿œç¨‹å‘é€è¯·æ±‚ä½ï¼ˆRemote Transfer Requestï¼ŒRTRï¼‰ï¼›

> ğŸŠæ ‡å‡†å¸§çš„IDä½æ˜¯11ä½ï¼Œå³èŒƒå›´æ˜¯0x000\~0x7FFï¼Œè€Œæ‰©å±•å¸§çš„IDæ˜¯11+18=29ä½ï¼›åœ¨CANåè®®ä¸­ï¼ŒIDå†³å®šæŠ¥æ–‡çš„ä¼˜å…ˆçº§é«˜ä½ï¼Œä¹Ÿå†³å®šè¿™æ‹“æ‰‘ç»“æ„çš„èŠ‚ç‚¹æ˜¯å¦æ¥æ”¶æ­¤IDçš„å¸§æ•°æ®ï¼›

> ğŸ¥•è¿œç¨‹å‘é€è¯·æ±‚ä½ï¼Œç”¨äºåŒºåˆ†è¯¥å¸§æ˜¯æ•°æ®å¸§è¿˜æ˜¯è¿œç¨‹å¸§ï¼Œæ˜¾æ€§ä¿¡å·ï¼ˆ0ï¼‰ä»£è¡¨æ•°æ®å¸§ï¼ˆData Frameï¼‰ï¼Œéšæ€§ä¿¡å·ï¼ˆ1ï¼‰ä»£è¡¨è¿œç¨‹å¸§ï¼ˆRemote Frameï¼‰ï¼›

> ğŸ‹æ§åˆ¶æ®µï¼ˆControl Fieldï¼‰ï¼šæ ‡å‡†å¸§ä¸­ç”±æ‰©å±•æ ‡è¯†ç¬¦ä½ï¼ˆIdentifier Extension bit-IDEï¼Œ1 bitï¼‰ã€ä¿ç•™ä½0ï¼ˆReseved bit0-r0ï¼Œ1 bitï¼‰ã€æ•°æ®é•¿åº¦ç¼–ç ä½ï¼ˆData Length Code-DLCï¼Œ4 bitsï¼‰ç»„æˆï¼›æ‰©å±•å¸§ç”¨ç”±ä¸¤ä¸ªä¿ç•™ä½ï¼ˆReseved bitï¼Œ2 bitï¼‰ã€æ•°æ®é•¿åº¦ç¼–ç ä½ï¼ˆData Length Code-DLCï¼Œ4 bitsï¼‰ç»„æˆ;

> ğŸ¥‘æ•°æ®æ®µï¼ˆData Fieldï¼‰ï¼šå‘é€æ•°æ®çš„å†…å®¹ï¼Œæœ€å¤š8ä¸ªå­—èŠ‚ï¼ˆ64bitï¼‰ï¼Œå®ƒçš„å®é™…é•¿åº¦ä¼šå†™åˆ°å‰é¢çš„æ•°æ®é•¿åº¦ç¼–ç ä½DLCé‡Œã€‚

> ğŸ‰å¾ªç¯æ ¡éªŒæ®µï¼ˆCRC Fieldï¼‰ï¼šåŒ…æ‹¬å¾ªç¯æ ¡éªŒåºåˆ—ï¼ˆCRC Sequenceï¼‰å’Œç•Œå®šç¬¦ï¼ˆDelimiterï¼ŒDELï¼‰ï¼›å¾ªç¯æ ¡éªŒåºåˆ—ç”¨äºæ ¡éªŒä¼ è¾“æ˜¯å¦æ­£ç¡®ï¼›ç•Œå®šç¬¦ç”¨äºè¡¨ç¤ºå¾ªç¯æ ¡éªŒåºåˆ—æ˜¯å¦ç»“æŸï¼›

> ğŸ«’ç¡®è®¤æ®µï¼ˆACK Fieldï¼‰ï¼šåŒ…æ‹¬ç¡®è®¤ä½ï¼ˆACK SLOTï¼‰å’Œç•Œå®šç¬¦ï¼ˆDelimiterï¼ŒDELï¼‰ï¼›ç¡®è®¤ä½åœ¨èŠ‚ç‚¹æ”¶åˆ°æ­£ç¡®çš„CRCåºåˆ—æ—¶ï¼Œå‘é€ç«¯çš„ACKä½è¢«ç½®ä½ï¼›ç•Œå®šç¬¦è¡¨ç¤ºç¡®è®¤æ˜¯å¦æ­£å¸¸æ¥æ”¶ï¼›
> å¸§ç»“æŸï¼ˆEnd of Frame-EOFï¼‰ï¼š7ä½é•¿åº¦ï¼Œéšæ€§ä¿¡å·ï¼Œè¡¨ç¤ºå¸§çš„ç»“æŸï¼›

## 2.CAN æ§åˆ¶å™¨

![](image/image_-AbvVlFLk0.png)

#### 2.1æ³¢ç‰¹ç‡

> ğŸ“ŒCANé‡‡ç”¨â€œä½åŒæ­¥â€æœºåˆ¶ï¼Œå®ç°å¯¹ç”µå¹³çš„æ­£ç¡®é‡‡æ ·ã€‚ä¼ è¾“ä¸­çš„æ¯ä½æ•°æ®ç”±å››æ®µç»„æˆï¼šåŒæ­¥æ®µï¼ˆSynchronization Segmentï¼ŒSSï¼‰ã€ä¼ æ’­æ—¶é—´æ®µï¼ˆPropagation TimeSegmentï¼ŒPTSï¼‰ã€ç›¸ä½ç¼“å†²æ®µ1ï¼ˆPhase Buffer Segment 1ï¼ŒPBS1ï¼‰å’Œç›¸ä½ç¼“å†²æ®µ2ï¼ˆPhase Buffer Segment 2ï¼Œ PBS2ï¼‰ã€‚æ¯æ®µåˆç”±å¤šä¸ªä½æ—¶åºï¼ˆTime Quantumï¼ŒTqï¼‰ç»„æˆï¼Œå¦‚å›¾ 23.1.6 æ‰€ç¤ºï¼Œä¸ºå„æ®µç»„æˆç¤ºæ„å›¾ã€‚

> ğŸ“ŒåŒæ­¥æ®µï¼ˆSynchronization Segmentï¼ŒSSï¼‰ 1tq  = can é¢‘ç‡

> ğŸ“Œä¼ æ’­æ—¶é—´æ®µï¼ˆPropagation TimeSegmentï¼ŒPTSï¼‰

> ğŸ“Œç›¸ä½ç¼“å†²æ®µ1ï¼ˆPhase Buffer Segment 1ï¼ŒPBS1ï¼‰

> ğŸ“Œç›¸ä½ç¼“å†²æ®µ2ï¼ˆPhase Buffer Segment 2ï¼Œ PBS2ï¼‰

![](image/image_U2ZMkoTM77.png)

> ğŸ‹å‡è®¾CANå¯¹åº”é€»è¾‘ç”µå¹³æŒç»­çš„æ—¶é—´ä¸º9Tqï¼Œå³ä¸€ä½æ•°æ®æŒç»­çš„æ—¶é—´ä¸º9Tqã€‚å…¶ä¸­SSæ®µé•¿åº¦ä¸º1Tqï¼ˆåªèƒ½ä¸º1Tqï¼‰ï¼ŒPTSæ®µé•¿åº¦ä¸º2Tqï¼ˆèŒƒå›´ä¸º18Tqï¼‰ï¼ŒPSB1æ®µé•¿åº¦ä¸º3Tqï¼ˆèŒƒå›´ä¸º18Tqï¼‰ï¼ŒPSB2æ®µé•¿åº¦ä¸º3Tqï¼ˆèŒƒå›´ä¸º2\~8Tqï¼‰ã€‚é‡‡æ ·ç‚¹åœ¨PSB1å’ŒPSB2ä¹‹é—´ï¼Œè°ƒæ•´å„æ®µçš„é•¿åº¦ï¼Œå³å¯å¯¹é‡‡æ ·ç‚¹ä½ç½®è¿›è¡Œè°ƒæ•´ï¼Œå®ç°è¡¥å¿å‡†ç¡®é‡‡æ ·ã€‚

![](image/image_0-RpwfNTX3.png)

> ğŸ«’å¦‚å›¾æ‰€ç¤ºï¼Œä¸ºSTM32F103ç³»åˆ—çš„CANæ§åˆ¶å™¨ä½æ—¶åºï¼Œå’Œæ ‡å‡†CANåè®®çš„ä½æ—¶åºç•¥æœ‰ä¸åŒã€‚STM32åªæœ‰ä¸‰æ®µï¼ŒåŒæ­¥æ®µé•¿åº¦ä¸º1Tqï¼ˆåªèƒ½ä¸º1Tqï¼‰ï¼Œæ ‡å‡†CANåè®®ä¸­çš„PTSæ®µå’ŒPSB1åˆå¹¶ä¸ºä½æ®µ1ï¼ˆèŒƒå›´ä¸º1-16Tqï¼‰ï¼Œæ ‡å‡†CANåè®®ä¸­çš„PSB2æ®µå¯¹åº”ä½æ®µ2ï¼ˆèŒƒå›´ä¸º1-8Tqï¼‰ã€‚

æ³¢ç‰¹ç‡è®¡ç®—

![](image/image_Xq2KLdol4w.png)

```c 
//---------------------------------------------------------------
    // åˆå§‹åŒ–CAN, ç½®ç›¸å…³å¯„å­˜å™¨ï¼Œ
    //---------------------------------------------------------------
    CAN_InitStructure.CAN_TTCM = DISABLE;
    CAN_InitStructure.CAN_ABOM = ENABLE;
    CAN_InitStructure.CAN_AWUM = DISABLE;
    CAN_InitStructure.CAN_NART = DISABLE;
    CAN_InitStructure.CAN_RFLM = DISABLE;
    CAN_InitStructure.CAN_TXFP = DISABLE;
    CAN_InitStructure.CAN_Mode = CAN_Mode_Normal;
    //---------------------------------------------------------------
    // CAN Baudrate = 125Kbps (CAN clocked at 42 MHz)
    // 42M/(21*(1+14+1)) = 125Kbps
    // CAN_InitStructure.CAN_SJW  = CAN_SJW_1tq;
    // CAN_InitStructure.CAN_BS1  = CAN_BS1_14tq;
    // CAN_InitStructure.CAN_BS2  = CAN_BS2_1tq;
    // CAN_InitStructure.CAN_Prescaler = 21;
    //---------------------------------------------------------------
    CAN_InitStructure.CAN_SJW  = CAN_SJW_1tq;
    CAN_InitStructure.CAN_BS1  = CAN_BS1_14tq;
    CAN_InitStructure.CAN_BS2  = CAN_BS2_1tq;
    CAN_InitStructure.CAN_Prescaler = 21;
```


[CANçš„ç”µå¹³çŠ¶æ€](https://www.wolai.com/Lq67QitdoQFydZwTNpJSc "CANçš„ç”µå¹³çŠ¶æ€")

[CANä¼šç›‘å¬è‡ªå‘æ•°æ®](https://www.wolai.com/7tVcK9846sSji4TAVjCNrv "CANä¼šç›‘å¬è‡ªå‘æ•°æ®")

[CANé€šä¿¡åè®®åº”ç”¨è®¾è®¡](https://www.wolai.com/2eqraNmtL32zaBsqkfu3rN "CANé€šä¿¡åè®®åº”ç”¨è®¾è®¡")

[æ¯”äºšè¿ªCANé€šä¿¡](https://www.wolai.com/oyi5aqe8hvvyRQoRh9qodW "æ¯”äºšè¿ªCANé€šä¿¡")
